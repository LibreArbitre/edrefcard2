name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install system dependencies (ImageMagick)
      run: |
        sudo apt-get update
        sudo apt-get install -y libmagickwand-dev

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install ruff mypy types-requests types-Flask types-cffi

    - name: Lint with Ruff
      run: |
        # Run ruff (equivalent to flake8/isort/pylint)
        # Use --exit-zero to not fail CI on linting errors, but still show warnings
        ruff check . --exit-zero

    - name: Type check with Mypy
      continue-on-error: true
      run: |
        # Run mypy for static type checking
        mypy www/scripts/

    - name: Test with pytest
      continue-on-error: true
      run: |
        pytest

    - name: Test Docker build and startup
      run: |
        # Build the Docker image
        docker build -t edrefcard-test .
        # Start the container with port mapping for testing
        docker run -d --name edrefcard-ci -p 8080:8000 edrefcard-test
        # Wait for application to be ready
        sleep 10
        # Smoke test: verify the app responds
        curl -f http://localhost:8080/ || exit 1
        # Cleanup
        docker stop edrefcard-ci
        docker rm edrefcard-ci
