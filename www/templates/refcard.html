{% extends "base.html" %}

{% block title %}EDRefCard - Reference Card{% endblock %}

{% block content %}
<div id="container">
    <div id="banner">
        <h1>EDRefCard</h1>
        <a href="{{ url_for('index') }}" class="banner-home-link" title="Return to homepage">âœ•</a>
    </div>

    <div id="content">
        {% if errors.unhandled_devices_warnings %}
        <div class="alert alert-warning">
            {{ errors.unhandled_devices_warnings|safe }}
        </div>
        {% endif %}

        {% if errors.misconfiguration_warnings %}
        <div class="alert alert-warning">
            {{ errors.misconfiguration_warnings|safe }}
        </div>
        {% endif %}

        {% if errors.device_warnings %}
        <div class="alert alert-warning">
            {{ errors.device_warnings|safe }}
        </div>
        {% endif %}

        {% if errors.errors %}
        <div class="alert alert-danger">
            {{ errors.errors|safe }}
        </div>
        {% endif %}

        {% if created_images or device_for_block_image %}
        {% for image in created_images %}
        {% if '::' in image %}
        {% set parts = image.split('::') %}
        {% set device = parts[0] %}
        {% set device_index = parts[1]|int %}
        {% else %}
        {% set device = image %}
        {% set device_index = 0 %}
        {% endif %}

        {% if device_index == 0 %}
        <img class="refcard-image lightbox-trigger"
            src="{{ url_for('serve_config', path=run_id[:2] + '/' + run_id + '-' + supported_devices[device]['Template'] + '.jpg') }}"
            alt="{{ device }} Reference Card" />
        {% else %}
        <img class="refcard-image lightbox-trigger"
            src="{{ url_for('serve_config', path=run_id[:2] + '/' + run_id + '-' + supported_devices[device]['Template'] + '-' + device_index|string + '.jpg') }}"
            alt="{{ device }} Reference Card ({{ device_index }})" />
        {% endif %}
        {% endfor %}

        {% if device_for_block_image %}
        <img class="refcard-image lightbox-trigger"
            src="{{ url_for('serve_config', path=supported_devices[device_for_block_image]['Template'][:2] + '/' + supported_devices[device_for_block_image]['Template'] + '.jpg') }}"
            alt="{{ device_for_block_image }} Block Diagram" />
        {% endif %}

        {% if not device_for_block_image and public and run_id %}
        <div class="form-section share-section" style="margin-top: 2rem;">
            <h3>ðŸ”— Share Your Reference Card</h3>
            
            <div class="share-grid">
                <!-- Direct Link -->
                <div class="share-item">
                    <label>Direct Link</label>
                    <div class="input-group">
                        <input type="text" value="{{ refcard_url }}" readonly id="refcardUrl">
                        <button onclick="copyToClipboard('refcardUrl')" class="btn-icon" title="Copy to Clipboard">
                            ðŸ“‹
                        </button>
                    </div>
                </div>

                <!-- Download Buttons -->
                <div class="share-actions">
                    <a href="{{ binds_url }}" class="btn-secondary" download>
                        ðŸ’¾ Download .binds
                    </a>
                    <div class="dropdown">
                        <button class="btn-secondary">ðŸ“„ Download PDF â–¼</button>
                        <div class="dropdown-content">
                            <a href="{{ url_for('download_pdf', run_id=run_id, format='A4') }}">A4 Format</a>
                            <a href="{{ url_for('download_pdf', run_id=run_id, format='Letter') }}">Letter Format</a>
                        </div>
                    </div>
                </div>

                <!-- Social Share -->
                <div class="social-share">
                    <a href="https://www.reddit.com/submit?url={{ refcard_url }}&title=My Elite Dangerous Bindings (EDRefCard)" 
                       target="_blank" rel="noopener noreferrer" class="btn-social reddit">
                       Run on Reddit
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out my Elite Dangerous bindings!&url={{ refcard_url }}" 
                       target="_blank" rel="noopener noreferrer" class="btn-social twitter">
                       Share on X
                    </a>
                </div>
            </div>

            <p class="text-muted mt-2">
                <small>You can replace your existing custom binds file with the downloaded .binds file to use these controls.</small>
            </p>
        </div>

        <script>
        function copyToClipboard(elementId) {
            var copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); /* For mobile devices */
            navigator.clipboard.writeText(copyText.value).then(() => {
                // Visual feedback could be added here
                const btn = copyText.nextElementSibling;
                const original = btn.innerHTML;
                btn.innerHTML = 'âœ…';
                setTimeout(() => btn.innerHTML = original, 2000);
            });
        }
        </script>
        {% endif %}
        {% endif %}
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="hidden">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
        <div id="lightbox-caption"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('serve_scripts', filename='lightbox.js') }}"></script>
{% endblock %}