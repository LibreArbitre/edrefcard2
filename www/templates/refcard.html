{% extends "base.html" %}

{% block title %}EDRefCard - Reference Card{% endblock %}

{% block content %}
<div id="container">
    <div id="banner">
        <h1>EDRefCard</h1>
        <a href="{{ url_for('web.index') }}" class="banner-home-link" title="Return to homepage">‚úï</a>
    </div>

    <div id="content">
        {% if errors.unhandled_devices_warnings %}
        <div class="alert alert-warning">
            {{ errors.unhandled_devices_warnings|safe }}
        </div>
        {% endif %}

        {% if errors.misconfiguration_warnings %}
        <div class="alert alert-warning">
            {{ errors.misconfiguration_warnings|safe }}
        </div>
        {% endif %}

        {% if errors.device_warnings %}
        <div class="alert alert-warning">
            {{ errors.device_warnings|safe }}
        </div>
        {% endif %}

        {% if errors.errors %}
        <div class="alert alert-danger">
            {{ errors.errors|safe }}
        </div>
        {% endif %}

        {% if created_images or device_for_block_image %}
        {% for image in created_images %}
        {% if '::' in image %}
        {% set parts = image.split('::') %}
        {% set device = parts[0] %}
        {% set device_index = parts[1]|int %}
        {% else %}
        {% set device = image %}
        {% set device_index = 0 %}
        {% endif %}

        {% if device_index == 0 %}
        <img class="refcard-image lightbox-trigger"
            src="{{ url_for('web.serve_config', path=run_id[:2] + '/' + run_id + '-' + supported_devices[device]['Template'] + '.jpg') }}"
            alt="{{ device }} Reference Card" />
        {% else %}
        <img class="refcard-image lightbox-trigger"
            src="{{ url_for('web.serve_config', path=run_id[:2] + '/' + run_id + '-' + supported_devices[device]['Template'] + '-' + device_index|string + '.jpg') }}"
            alt="{{ device }} Reference Card ({{ device_index }})" />
        {% endif %}
        {% endfor %}

        {% if device_for_block_image %}
        <img class="refcard-image lightbox-trigger"
            src="{{ url_for('web.serve_config', path=supported_devices[device_for_block_image]['Template'][:2] + '/' + supported_devices[device_for_block_image]['Template'] + '.jpg') }}"
            alt="{{ device_for_block_image }} Block Diagram" />
        {% endif %}

        {% if not device_for_block_image and public and run_id %}
        <div class="form-section share-section" style="margin-top: 2rem;">
            <h3>üîó Share Your Reference Card</h3>

            <div class="share-grid">
                <!-- Direct Link -->
                <div class="share-item">
                    <label>Direct Link</label>
                    <div class="input-group">
                        <input type="text" value="{{ refcard_url }}" readonly id="refcardUrl">
                        <button onclick="copyToClipboard('refcardUrl')" class="btn-icon" title="Copy to Clipboard">
                            üìã
                        </button>
                    </div>
                </div>

                <!-- Download Buttons -->
                <div class="share-actions">
                    <a href="{{ binds_url }}" class="btn-secondary" download>
                        üíæ Download .binds
                    </a>
                    <div class="dropdown">
                        <button class="btn-secondary">üìÑ Download PDF ‚ñº</button>
                        <div class="dropdown-content">
                            <a href="{{ url_for('web.download_pdf', run_id=run_id, format='A4') }}">A4 Format</a>
                            <a href="{{ url_for('web.download_pdf', run_id=run_id, format='Letter') }}">Letter
                                Format</a>
                        </div>
                    </div>
                </div>

                <div class="social-share">
                    <a href="https://www.reddit.com/submit?url={{ refcard_url }}&title=My Elite Dangerous Bindings (EDRefCard)"
                        target="_blank" rel="noopener noreferrer" class="btn-social reddit" title="Share on Reddit">
                        <span style="font-size: 1.2em;">üî¥</span> Reddit
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out my Elite Dangerous bindings!&url={{ refcard_url }}"
                        target="_blank" rel="noopener noreferrer" class="btn-social twitter" title="Share on X">
                        <span style="font-size: 1.2em;">‚úñÔ∏è</span> X
                    </a>
                    <button onclick="copyToClipboard('refcardUrl')" class="btn-social discord"
                        style="background-color: #5865F2; color: white; border: none; cursor: pointer;"
                        title="Copy Link for Discord">
                        <span style="font-size: 1.2em;">üí¨</span> Discord
                    </button>
                    <button onclick="toggleQRCode()" class="btn-social qrcode"
                        style="background-color: #fff; color: #333; border: 1px solid #ccc; cursor: pointer;"
                        title="Show QR Code">
                        <span style="font-size: 1.2em;">üì±</span> QR Code
                    </button>
                </div>
            </div>

            <!-- QR Code Container (Hidden by default) -->
            <div id="qrcode-container" style="display: none; margin-top: 1rem; text-align: center;">
                <div id="qrcode" style="display: inline-block; padding: 10px; background: white;"></div>
                <p><small>Scan to open on mobile</small></p>
            </div>

            <p class="text-muted mt-2">
                <small>You can replace your existing custom binds file with the downloaded .binds file to use these
                    controls.</small>
            </p>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <script>
            function copyToClipboard(elementId) {
                var copyText = document.getElementById(elementId);
                copyText.select();
                copyText.setSelectionRange(0, 99999); /* For mobile devices */
                navigator.clipboard.writeText(copyText.value).then(() => {
                    // Find the button that was clicked
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.tagName === 'BUTTON') {
                        const original = activeElement.innerHTML;
                        activeElement.innerHTML = '‚úÖ Copied!';
                        setTimeout(() => activeElement.innerHTML = original, 2000);
                    }
                });
            }

            var qrCodeGenerated = false;
            function toggleQRCode() {
                var container = document.getElementById('qrcode-container');
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    if (!qrCodeGenerated) {
                        new QRCode(document.getElementById("qrcode"), {
                            text: "{{ refcard_url }}",
                            width: 128,
                            height: 128
                        });
                        qrCodeGenerated = true;
                    }
                } else {
                    container.style.display = 'none';
                }
            }
        </script>
        {% endif %}
        {% endif %}
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="hidden">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
        <div id="lightbox-caption"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('web.serve_scripts', filename='lightbox.js') }}"></script>
{% endblock %}